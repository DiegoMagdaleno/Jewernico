<!DOCTYPE html>
<html lang="en" data-theme="cupcake">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.7/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="flex items-center justify-center">
    <dialog id="myModal" class="modal">
        <div class="modal-box">
            <div class="flex flex-col items-center">
                <form id="question-form" class="flex flex-col items-center">
                    <label for="password">Nueva Contraseña:</label>
                    <input type="password" id="password" name="nuevaContraseña"
                        class="input input-bordered w-full max-w-sm" required>

                    <label for="confirmPassword">Confirmar Nueva Contraseña:</label>
                    <input type="password" id="confirmPassword" name="confirmarContraseña"
                        class="input input-bordered w-full max-w-sm" required>
                    <input type="button" id="question-submit" class="btn btn-primary" value="Enviar">
                </form>
            </div>
        </div>
    </dialog>
    <div class="container p-8 mt-16">
        <div class="bg-white overflow-hidden shadow-xl sm:rounded-lg p-8 max-w-4xl mx-auto" id="content">
            <div class="mb-4 flex flex-col items-center justify-center">
                <h3 class="text-3xl font-bold pb-3">Recuperar Contraseña</h3>
                <p class="text-lg text-gray-500 pb-2">Ingresa tu correo electronico</p>
            </div>
            <form action="" id="loginForm">
                <div class="flex flex-col items-center justify-center">
                    <div class="w-1/2 pr-2 pb-3">
                        <label for="correo" class="block text-lg text-gray-500 mb-2">Correo:</label>
                        <div class="flex items-center">
                            <input type="email" id="correo" name="correoElectronico"
                                class="input input-bordered w-full max-w-sm" placeholder="tucorreo@gmail.com" required>
                            <input type="button" id="enviar" class="btn btn-primary" value="Enviar">
                        </div>
                    </div>
            </form>
        </div>
    </div>
    <script>
        $("#enviar").click(function () {
            let correo = $("#correo").val();
            let data = {
                correoElectronico: correo
            }
            jsonData = JSON.stringify(data);
            axios.post("http://localhost/php_course/Jewernico/backend/questions/email", jsonData, {
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(function (response) {
                    let idPregunta = response.data.Id;
                    const preguntaDiv = $("<div>")
                        .addClass("flex flex-col items-center justify-center");

                    const preguntaLabel = $("<label>")
                        .attr("for", "pregunta")
                        .addClass("block text-lg text-gray-500 mb-2")
                        .text(response.data.Pregunta);

                    const preguntaInput = $("<input>")
                        .attr({
                            type: "text",
                            id: "pregunta",
                            class: "input input-bordered w-full max-w-sm",
                            required: true
                        });

                    const enviarButton = $("<button>")
                        .addClass("btn btn-primary")
                        .text("Enviar Solicitud")
                        .click(function () {
                            let respuesta = $("#pregunta").val();
                            let data = {
                                correoElectronico: correo,
                                IdPregunta: idPregunta,
                                Respuesta: respuesta
                            }
                            jsonData = JSON.stringify(data);
                            axios.post("http://localhost/php_course/Jewernico/backend/questions/answer", jsonData, {
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                                .then(function (response) {
                                    localStorage.setItem("refreshToken", response.data.refreshToken)
                                    document.cookie = `token=${response.data.token}; path=/`;
                                    $("#myModal")[0].showModal();
                                    $("#question-submit").click(function () {
                                        let password = $("#password").val();
                                        let confirmPassword = $("#confirmPassword").val();
                                        if (password == confirmPassword) {
                                            let data = {
                                                correoElectronico: correo,
                                                password: password
                                            }
                                            jsonData = JSON.stringify(data);
                                            axios.post("http://localhost/php_course/Jewernico/backend/password/reset", jsonData, {
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                }
                                            })
                                                .then(function (response) {
                                                    window.location.href = "http://localhost/php_course/Jewernico/";
                                                })
                                                .catch(function (error) {
                                                    console.log(error);
                                                })
                                        }
                                    })
                                })
                                .catch(function (error) {
                                    console.log(error);
                                })
                        });

                    preguntaDiv.append(preguntaLabel, preguntaInput, enviarButton);
                    $("#content").append(preguntaDiv);
                })
                .catch(function (error) {
                    console.log(error);
                })

        })
    </script>
</body>

</html>