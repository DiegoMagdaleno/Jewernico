<!DOCTYPE html>
<html lang="en" data-theme="cupcake">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://www.jsviews.com/download/jsrender.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/state.js" type="module"></script>
    <script src="js/listenarray.js" type="module"></script>
</head>

<body>
    <div class="grid grid-cols-6 grid-rows-1 h-screen">
        <aside class="transform top-0 left-0 bg-white h-full grid-span-1">
            <div class="flex flex-col h-full">
                <div class="flex items-center justify-center h-16 border-b border-gray-200">
                    <h1 class="text-lg font-semibold text-gray-800">Panel de control</h1>
                </div>
                <div class="flex flex-col flex-1 overflow-y-auto">
                    <ul class="flex flex-col py-4 space-y-1">
                        <li>
                            <a href="#" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100">
                                <i class="icon-home"></i>
                                <span class="mx-4 font-medium">Inicio</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100">
                                <i class="icon-shopping-cart"></i>
                                <span class="mx-4 font-medium">Pedidos</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100">
                                <i class="icon-collection"></i>
                                <span class="mx-4 font-medium">Colecciones</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100">
                                <i class="icon-box"></i>
                                <span class="mx-4 font-medium">Productos</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>
        <div class="col-span-5 row-span-1 bg-base-200" id="current-panel-render">
        </div>
    </div>
    <script id="productTemplate" type="text/x-jsrender">
    {{for}}
        <tr>
            <td>
                <label>
                    <input type="checkbox" class="checkbox" value={{>Id}}>
                </label>
            </td>
            <td>{{>Nombre}}</td>
            <td>{{>Descripcion}}</td>
            <td>{{>Precio}}</td>
            <td>{{>Material}}</td>
            <td>{{>Categoria}}</td>
            <td>{{>Stock}}</td>
        </tr>
    {{/for}}
    </script>
    <script type="text/javascript">
        class ArrayEmitter extends Array {
            constructor(...args) {
                super(...args);
            }

            push(...args) {
                const result = super.push(...args);
                this.emitChange();
                return result;
            }

            pop() {
                const result = super.pop();
                this.emitChange();
                return result;
            }

            splice(...args) {
                const result = super.splice(...args);
                this.emitChange();
                return result;
            }

            clear() {
                this.splice(0, this.length);
            }

            emitChange() {
                if (this.onArrayChange) {
                    this.onArrayChange(Array.from(this));
                }
            }

            onArrayChangeEvent(callback) {
                this.onArrayChange = callback;
            }
        }

        const STATE = {
            currentView: 'products',
            products: new ArrayEmitter(),
        }
        function renderProductView() {
            $('#current-panel-render').load('views/products.html');
            let products = [];
            const productsRequest = axios.get('http://localhost/php_course/Jewernico/backend/products');
            const categoriesRequest = axios.get('http://localhost/php_course/Jewernico/backend/categories');
            const materialsRequest = axios.get('http://localhost/php_course/Jewernico/backend/materials');
            axios.all([productsRequest, categoriesRequest, materialsRequest]).then(axios.spread((...responses) => {
                const productsResponse = responses[0];
                const categoriesResponse = responses[1];
                const materialsResponse = responses[2];
                products = productsResponse.data;
                const categories = categoriesResponse.data;
                const materials = materialsResponse.data;
                products.forEach(product => {
                    product.Categoria = categories.find(category => category.Id == product.IdMaterial).Nombre;
                    product.Material = materials.find(material => material.Id == product.IdCategoria).Nombre;
                });

                $('#productList').html(
                    $('#productTemplate').render(products)
                );

                $('#check-all').change(function () {
                    if ($(this).is(':checked')) {
                        $('.checkbox').prop('checked', true);
                    } else {
                        $('.checkbox').prop('checked', false);
                    }
                });

                $('.checkbox').change(function () {
                    if ($('.checkbox:checked').length == $('.checkbox').length) {
                        $('#check-all').prop('checked', true);
                    } else {
                        $('#check-all').prop('checked', false);
                    }
                });

                $('.checkbox').change(function () {
                    if ($(this).is(':checked')) {
                        $(this).closest('tr').addClass('selected');
                        STATE.products.push($(this).val());
                        console.log(STATE.products);
                    } else {
                        $(this).closest('tr').addClass('selected');
                        STATE.products.splice(STATE.products.indexOf($(this).val()), 1);
                        console.log(STATE.products);
                    }
                })

                $('#addButton').off('click');
                $('#editButton').off('click');

                STATE.products.onArrayChangeEvent(function (newState) {
                    console.log("I am here");
                    if (newState.length === 0) {
                        $("#editButton").prop("disabled", true);
                        $("#deleteButton").prop("disabled", true);
                        $("#editButton").addClass("btn-disabled");
                        $("#deleteButton").addClass("btn-disabled");
                    } else if (newState.length === 1) {
                        $("#editButton").prop("disabled", false);
                        $("#deleteButton").prop("disabled", false);
                        $("#editButton").removeClass("btn-disabled");
                        $("#deleteButton").removeClass("btn-disabled");
                    } else {
                        $("#editButton").prop("disabled", true);
                        $("#deleteButton").prop("disabled", false);
                        $("#editButton").addClass("btn-disabled");
                        $("#deleteButton").removeClass("btn-disabled");
                    }
                });

                $('#editButton').click(function () {
                    $("#current-panel-render").load("views/add-product.html", function () {
                        $(document).on('click', "#back-button", function () {
                            renderProductView();
                            window.location.reload();
                        });

                        const categoriesSelect = $('#categoria-select');
                        const materialsSelect = $('#material-select');

                        axios.all([categoriesRequest, materialsRequest]).then(axios.spread((...responses) => {
                            const categoriesResponse = responses[0];
                            const materialsResponse = responses[1];
                            const categories = categoriesResponse.data;
                            const materials = materialsResponse.data;

                            categories.forEach(category => {
                                categoriesSelect.append(
                                    $('<option>', {
                                        value: category.Id,
                                        text: category.Nombre
                                    })
                                );
                            });

                            materials.forEach(material => {
                                materialsSelect.append(
                                    $('<option>', {
                                        value: material.Id,
                                        text: material.Nombre
                                    })
                                );
                            });
                        }));

                        const productRequest = axios.get(`http://localhost/php_course/Jewernico/backend/products/${STATE.products[0]}`);
                        axios.all([productRequest]).then(axios.spread((...responses) => {
                            const productResponse = responses[0];
                            const product = productResponse.data[0];
                            $('#nombre').val(product.Nombre);
                            $('#descripcion').val(product.Descripcion);
                            $('#precio').val(product.Precio);
                            $('#material-select').val(product.IdMaterial);
                            $('#categoria-select').val(product.IdCategoria);
                            $('#descuento').val(product.Descuento);
                            $('#stock').val(product.Stock);
                        }));

                        $("#save-button").click(function () {
                            let formValid = true;
                            $('#addProductForm input[required]').each(function () {
                                if (!$(this).val().trim()) {
                                    $(this).addClass('input-error');
                                    $('label[for="' + $(this).attr('id') + '"]').addClass('text-red-500');
                                    formValid = false;
                                } else {
                                    $(this).removeClass('input-error');
                                    $('label[for="' + $(this).attr('id') + '"]').removeClass('text-red-500');
                                }
                            });

                            if (formValid) {
                                let formData = $('#addProductForm').serializeArray();
                                let jsonObject = {};
                                $.each(formData, function () {
                                    jsonObject[this.name] = this.value || '';
                                });
                                let jsonData = JSON.stringify(jsonObject);
                                console.log(jsonData);
                                $.ajax({
                                    url: `http://localhost/php_course/Jewernico/backend/products/${STATE.products[0]}`,
                                    type: 'POST',
                                    data: jsonData,
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    success: function (response) {
                                        console.log(response);
                                        Swal.fire({
                                            icon: 'success',
                                            title: 'Producto editado correctamente',
                                        });
                                        renderProductView();
                                        window.location.reload();
                                    },
                                    error: function (response) {
                                        console.log(response);
                                        let errorMessage = JSON.parse(response.responseText).message;
                                        let toast = $('<div class="toast toast-end">' +
                                            '<div class="alert alert-error">' +
                                            '<span>' + errorMessage + '</span>' +
                                            '</div>' +
                                            '</div>');
                                        $('body').append(toast);
                                        setTimeout(function () {
                                            toast.fadeOut('slow', function () {
                                                $(this).remove();
                                            });
                                        }, 5000);
                                    }
                                });
                            }
                        });
                    })
                });

                $('#deleteButton').click(function () {
                    for (let i = 0; i < STATE.products.length; i++) {
                        axios.delete(`http://localhost/php_course/Jewernico/backend/products/${STATE.products[i]}`)
                            .then(function (response) {
                                console.log(response);
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Producto eliminado correctamente',
                                });
                                renderProductView();
                                window.location.reload();
                            })
                            .catch(function (error) {
                                console.log(error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error al eliminar el producto',
                                });
                            });
                    }
                });

                $('#addButton').click(function () {
                    $("#current-panel-render").load("views/add-product.html", function () {
                        $(document).on('click', "#back-button", function () {
                            renderProductView();
                            window.location.reload();
                        });

                        const categoriesSelect = $('#categoria-select');
                        const materialsSelect = $('#material-select');

                        axios.all([categoriesRequest, materialsRequest]).then(axios.spread((...responses) => {
                            const categoriesResponse = responses[0];
                            const materialsResponse = responses[1];
                            const categories = categoriesResponse.data;
                            const materials = materialsResponse.data;

                            categories.forEach(category => {
                                categoriesSelect.append(
                                    $('<option>', {
                                        value: category.Id,
                                        text: category.Nombre
                                    })
                                );
                            });

                            materials.forEach(material => {
                                materialsSelect.append(
                                    $('<option>', {
                                        value: material.Id,
                                        text: material.Nombre
                                    })
                                );
                            });
                        }));

                        $("#save-button").click(function () {
                            let formValid = true;
                            $('#addProductForm input[required]').each(function () {
                                if (!$(this).val().trim()) {
                                    $(this).addClass('input-error');
                                    $('label[for="' + $(this).attr('id') + '"]').addClass('text-red-500');
                                    formValid = false;
                                } else {
                                    $(this).removeClass('input-error');
                                    $('label[for="' + $(this).attr('id') + '"]').removeClass('text-red-500');
                                }
                            });

                            if (formValid) {
                                let formData = $('#addProductForm').serializeArray();
                                let jsonObject = {};
                                $.each(formData, function () {
                                    jsonObject[this.name] = this.value || '';
                                });
                                let jsonData = JSON.stringify(jsonObject);
                                console.log(jsonData);
                                $.ajax({
                                    url: 'http://localhost/php_course/Jewernico/backend/products',
                                    type: 'POST',
                                    data: jsonData,
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    success: function (response) {
                                        console.log(response);
                                        Swal.fire({
                                            icon: 'success',
                                            title: 'Producto agregado correctamente',
                                        });
                                        renderProductView();
                                        window.location.reload();
                                    },
                                    error: function (response) {
                                        console.log(response);
                                        let errorMessage = JSON.parse(response.responseText).message;
                                        let toast = $('<div class="toast toast-end">' +
                                            '<div class="alert alert-error">' +
                                            '<span>' + errorMessage + '</span>' +
                                            '</div>' +
                                            '</div>');
                                        $('body').append(toast);
                                        setTimeout(function () {
                                            toast.fadeOut('slow', function () {
                                                $(this).remove();
                                            });
                                        }, 5000);
                                    }
                                });
                            }
                        });
                    });
                });
            })).catch(errors => {
                console.log(errors);
            });
        }

        if (STATE.currentView == 'products') {
            $(document).ready(function () {
                renderProductView();
            })
        }
    </script>
</body>

</html>